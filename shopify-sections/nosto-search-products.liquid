{% comment %}
  Nosto Search Products Section

  This section is designed to work with Shopify's Section Rendering API
  and the nosto-section-campaign web component. It renders products based
  on a colon-separated list of product handles passed via the search query
  parameter (search.terms).

  Usage with nosto-section-campaign:
  <nosto-section-campaign 
    placement="front-page" 
    section="nosto-search-products">
  </nosto-section-campaign>

  The component will pass product handles as: ?q=handle1:handle2:handle3
  which becomes available in Liquid as search.terms
{% endcomment %}

{% if search.terms != blank %}
  {% assign handles = search.terms | split: ':' %}
  
  <div class="nosto-search-products" data-section-id="{{ section.id }}">
    {% if section.settings.heading != blank %}
      <h2 class="nosto-search-products__heading" nosto-title>
        {{ section.settings.heading }}
      </h2>
    {% endif %}

    {% if section.settings.description != blank %}
      <div class="nosto-search-products__description">
        {{ section.settings.description }}
      </div>
    {% endif %}

    <div class="nosto-search-products__grid" style="
      display: grid;
      grid-template-columns: repeat({{ section.settings.products_per_row }}, 1fr);
      gap: {{ section.settings.grid_gap }}px;
    ">
      {% for handle in handles %}
        {% assign product = all_products[handle] %}
        
        {% if product != blank %}
          <div class="nosto-search-products__item" data-product-handle="{{ product.handle }}">
            {% for block in section.blocks %}
              {% case block.type %}
                {% when 'product_image' %}
                  {% if product.featured_image %}
                    <div class="nosto-product-image" {{ block.shopify_attributes }}>
                      <a href="{{ product.url }}">
                        <img 
                          src="{{ product.featured_image | image_url: width: block.settings.image_width }}" 
                          alt="{{ product.featured_image.alt | default: product.title | escape }}"
                          width="{{ block.settings.image_width }}"
                          loading="lazy"
                        >
                      </a>
                    </div>
                  {% endif %}

                {% when 'product_title' %}
                  <div class="nosto-product-title" {{ block.shopify_attributes }}>
                    <h3 style="font-size: {{ block.settings.title_size }}px;">
                      <a href="{{ product.url }}">{{ product.title }}</a>
                    </h3>
                  </div>

                {% when 'product_price' %}
                  <div class="nosto-product-price" {{ block.shopify_attributes }}>
                    {% if product.compare_at_price > product.price %}
                      <span class="nosto-product-price__sale">
                        {{ product.price | money }}
                      </span>
                      <span class="nosto-product-price__compare">
                        {{ product.compare_at_price | money }}
                      </span>
                    {% else %}
                      <span class="nosto-product-price__regular">
                        {{ product.price | money }}
                      </span>
                    {% endif %}
                  </div>

                {% when 'product_description' %}
                  <div class="nosto-product-description" {{ block.shopify_attributes }}>
                    {{ product.description | truncate: block.settings.description_length }}
                  </div>

                {% when 'product_vendor' %}
                  {% if product.vendor != blank %}
                    <div class="nosto-product-vendor" {{ block.shopify_attributes }}>
                      {{ product.vendor }}
                    </div>
                  {% endif %}

                {% when 'product_button' %}
                  <div class="nosto-product-button" {{ block.shopify_attributes }}>
                    <a href="{{ product.url }}" class="button">
                      {{ block.settings.button_text }}
                    </a>
                  </div>

                {% when 'custom_liquid' %}
                  <div class="nosto-custom-liquid" {{ block.shopify_attributes }}>
                    {{ block.settings.custom_liquid }}
                  </div>

              {% endcase %}
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% else %}
  <div class="nosto-search-products--empty">
    {% if section.settings.empty_message != blank %}
      <p>{{ section.settings.empty_message }}</p>
    {% endif %}
  </div>
{% endif %}

{% schema %}
{
  "name": "Nosto Search Products",
  "tag": "section",
  "class": "nosto-search-products-section",
  "templates": ["search"],
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recommended Products"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "info": "Optional description text displayed above products"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Products per row",
      "default": 4
    },
    {
      "type": "range",
      "id": "grid_gap",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Grid gap",
      "default": 20
    },
    {
      "type": "text",
      "id": "empty_message",
      "label": "Empty state message",
      "default": "No products to display"
    }
  ],
  "blocks": [
    {
      "type": "product_image",
      "name": "Product Image",
      "limit": 1,
      "settings": [
        {
          "type": "range",
          "id": "image_width",
          "min": 100,
          "max": 800,
          "step": 50,
          "unit": "px",
          "label": "Image width",
          "default": 400
        }
      ]
    },
    {
      "type": "product_title",
      "name": "Product Title",
      "limit": 1,
      "settings": [
        {
          "type": "range",
          "id": "title_size",
          "min": 12,
          "max": 32,
          "step": 2,
          "unit": "px",
          "label": "Title size",
          "default": 18
        }
      ]
    },
    {
      "type": "product_price",
      "name": "Product Price",
      "limit": 1
    },
    {
      "type": "product_description",
      "name": "Product Description",
      "limit": 1,
      "settings": [
        {
          "type": "range",
          "id": "description_length",
          "min": 50,
          "max": 500,
          "step": 50,
          "label": "Description length",
          "default": 150
        }
      ]
    },
    {
      "type": "product_vendor",
      "name": "Product Vendor",
      "limit": 1
    },
    {
      "type": "product_button",
      "name": "Product Button",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "button_text",
          "label": "Button text",
          "default": "View Product"
        }
      ]
    },
    {
      "type": "custom_liquid",
      "name": "Custom Liquid",
      "settings": [
        {
          "type": "liquid",
          "id": "custom_liquid",
          "label": "Custom Liquid",
          "info": "Add custom Liquid code with access to the product variable"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Nosto Search Products",
      "blocks": [
        {
          "type": "product_image"
        },
        {
          "type": "product_title"
        },
        {
          "type": "product_price"
        }
      ]
    }
  ]
}
{% endschema %}
